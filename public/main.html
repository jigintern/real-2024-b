<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta charset="utf-8" />
    <title>HeyHey</title>
    <link rel="stylesheet" href="style.css" />
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const name = document.getElementById("usrName");
        name.innerHTML = localStorage.getItem("name");
        const active = document.getElementById("active");
        active.innerHTML = localStorage.getItem("active");
        const editButton = document.getElementById("editButton");
        editButton.addEventListener("click", function (event) {
          console.log("Edit button clicked");
          localStorage.setItem("active", "");
          window.location.href = "/index.html";
        });
      });
    </script>
    <script
      src="https://code.jquery.com/jquery-3.3.1.min.js"
      integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
      crossorigin="anonymous"
    ></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.qrcode/1.0/jquery.qrcode.min.js"></script>
    <script src="https://unpkg.com/encoding-japanese@2.2.0/encoding.min.js"></script>
    <script src=https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js></script>
    <script type="text/javascript">
      $(document).ready(function () {
        $("button[name='size']").on("click", function (e) {
          const qrBtn = document.getElementById("qrBtn");
          qrBtn.style.display = "none";
          var name = localStorage.getItem("name");
          var event = localStorage.getItem("active");
          var value = name + "/" + event;
          console.log(value);
          e.preventDefault();
          var size = $(this).val();
          var source = Encoding.convert(value, "SJIS");

          try {
            $("#QRCode").html("").qrcode({
              width: size,
              height: size,
              text: source,
            });
          } catch (e) {
            $("#QRCode")
              .html("")
              .append("ÊñáÂ≠óÊï∞„Ç™„Éº„Éê„Éº„Åß„ÅôÔºö<br>" + e);
          }
        });
      });
    </script>
  </head>
  <body>
    <header id="header"></header>
    <div id="container">
      <div id="QR">
        <div id="QRCode"></div>
        <div>
          <div class="col-sm-6">
            <div>
              <button class="btn btn-primary" value="180" name="size" id="qrBtn">
                QR„ÇíË°®Á§∫
                <!-- <img src="./img/readQR.png" alt="QR„Ç≥„Éº„ÉâË™≠„ÅøÂèñ„Çä" id="readQrImg" /> -->
              </button>
            </div>
          </div>
          <div id="QRCode"></div>
        </div>
      </div>
      <div id="recordContainer">
        <div id="loadingMessage">
          <!-- üé• Unable to access video stream (please make sure you have a webcam
          enabled) -->
        </div>
        <canvas id="canvas" hidden></canvas>
        <div id="output" hidden>
          <div id="outputMessage">No QR code detected.</div>
          <div hidden><b>„Å™„Åæ„Åà:</b> <span id="output_nameData"></span></div>
          <div hidden>
            <b>ÊúÄËøë„ÅÆ„Åß„Åç„Åî„Å®:</b> <span id="output_eventData"></span>
          </div>
        </div>
      </div>
      <div id="icon">
        <img src="img/noImage.jpg" alt="icon image" id="iconImg" />
        <div id="usrName"></div>
      </div>
      <div id="textContainer">
        <div>ÊúÄËøë„ÅÇ„Å£„Åü„Åì„Å®</div>
        <div id="active"></div>
      </div>
      <div>
        <button id="editButton">Edit</button>
        <button id = heatmapButton type=‚Äúbutton‚Äù onclick="location.href='/heatmap.html'">„Éí„Éº„Éà„Éû„ÉÉ„Éó</button>
      </div>
    </div>
    <script>
      $(document).ready(function () {
      $("button[name='size']").on("click", function (e) {
        var video = document.createElement("video");
        var canvasElement = document.getElementById("canvas");
        var canvas = canvasElement.getContext("2d");
        var loadingMessage = document.getElementById("loadingMessage");
        var outputContainer = document.getElementById("output");
        var outputMessage = document.getElementById("outputMessage");
        var output_nameData = document.getElementById("output_nameData");
        var output_eventData = document.getElementById("output_eventData");

      function drawLine(begin, end, color) {
        canvas.beginPath();
        canvas.moveTo(begin.x, begin.y);
        canvas.lineTo(end.x, end.y);
        canvas.lineWidth = 4;
        canvas.strokeStyle = color;
        canvas.stroke();
      }

      // Use facingMode: environment to attemt to get the front camera on phones
      navigator.mediaDevices
        .getUserMedia({ video: { facingMode: "user" } })
        .then(function (stream) {
          video.srcObject = stream;
          video.setAttribute("playsinline", true); // required to tell iOS safari we don't want fullscreen
          video.play();
          requestAnimationFrame(tick);
        });

      function tick() {
        loadingMessage.innerText = "‚åõ Loading video...";
        if (video.readyState === video.HAVE_ENOUGH_DATA) {
          loadingMessage.hidden = true;
          canvasElement.hidden = false;
          outputContainer.hidden = false;

          canvasElement.height = 100;
          canvasElement.width = 100;
          canvas.drawImage(
            video,
            0,
            0,
            canvasElement.width,
            canvasElement.height
          );
          var imageData = canvas.getImageData(
            0,
            0,
            canvasElement.width,
            canvasElement.height
          );
          var code = jsQR(imageData.data, imageData.width, imageData.height, {
            inversionAttempts: "dontInvert",
          });
          if (code) {
            drawLine(
              code.location.topLeftCorner,
              code.location.topRightCorner,
              "#FF3B58"
            );
            drawLine(
              code.location.topRightCorner,
              code.location.bottomRightCorner,
              "#FF3B58"
            );
            drawLine(
              code.location.bottomRightCorner,
              code.location.bottomLeftCorner,
              "#FF3B58"
            );
            drawLine(
              code.location.bottomLeftCorner,
              code.location.topLeftCorner,
              "#FF3B58"
            );
            outputMessage.hidden = true;
            output_nameData.parentElement.hidden = false;
            output_eventData.parentElement.hidden = false;
            var text_decoder = new TextDecoder("shift-jis");
            var text = text_decoder.decode(
              Uint8Array.from(code.binaryData).buffer
            );
            var userdata = text.split("/");
            output_nameData.innerText = userdata[0];
            output_eventData.innerText = userdata[1];
          } else {
            outputMessage.hidden = false;
            output_nameData.parentElement.hidden = true;
            output_eventData.parentElement.hidden = true;
          }
        }
        requestAnimationFrame(tick);
      }
        });
      });
      
    </script>
  </body>
</html>